"use strict";function UsersCtrl(){EventEmitter.call(this)}var path=require("path"),EventEmitter=require("events"),config=require(path.resolve("./config/config")),sequelize=require(path.resolve("./config/lib/sequelize")),session=require("express-session"),dbTools=require(path.resolve("./config/private/dbtools")),logger=require(path.resolve("./config/lib/logger")).getLogger_FileNameBase(__filename);UsersCtrl.prototype=Object.create(EventEmitter.prototype);var usersCtrl=module.exports=new UsersCtrl;usersCtrl.USERRELOGIN="USERRELOGIN",usersCtrl.USERLOGIN="USERLOGIN",usersCtrl.USERLOGOUT="USERLOGOUT",usersCtrl.USERSIGNUP="USERSIGNUP",usersCtrl.userSession={},usersCtrl.getUserId=function(e){return"object"==typeof e&&(e=e.id),e},usersCtrl.getUserName=function(e){return"object"==typeof e&&(e=e.username),e},usersCtrl.userSessionCheck=function(e,r){var s=this.getUserId(e),t=this;return new Promise(function(o,n){if("number"!=typeof s)return logger.error("userSessionCheck error user param:",s),n(new Error("userSessionCheck error user param:"+s));var i=t.userSession[s];if(i)return i===r?o(!1):(logger.warn("user id:%s,name:%s sessionID %s has prev sessionID %s, prev session destroy",s,e.username,r,i),dbTools.getSessionStore().destroy(i,function(r){return t.emit(t.USERRELOGIN,e),o(!0)}));o(!0)}).then(function(o){o&&(t.userSession[s]=r,logger.info("user %s(%s) session saved.",t.getUserName(e),s))}).catch(function(t){logger.error("userSessionCheck user id:%s,name:%s, sessionID %s error:",s,e.username,r,t)})},usersCtrl.userSessionClear=function(e){var r=this;return new Promise(function(s,t){var o=r.getUserId(e);logger.info("user %s(%s) session clear.",r.getUserName(e),o),"number"!=typeof o?logger.error("userSessionClear error user param"):delete r.userSession[o],s()})},usersCtrl.signin=function(e,r){var s=this;return new Promise(function(r,t){logger.info("user %s login",s.getUserName(e)),s.emit(s.USERLOGIN,e),r()})},usersCtrl.signup=function(e,r){var s=this;return new Promise(function(r,t){logger.info("user %s signup",s.getUserName(e)),s.emit(s.USERSIGNUP,e),r()})},usersCtrl.signout=function(e){var r=this;return new Promise(function(s,t){logger.info("user %s logout",r.getUserName(e)),r.emit(r.USERLOGOUT,e),s()})};