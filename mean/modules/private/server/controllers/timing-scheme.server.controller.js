"use strict";var path=require("path"),config=require(path.resolve("./config/config")),dbTools=require(path.resolve("./config/private/dbtools")),putils=require(path.resolve("./config/private/utils")),sequelize=require(path.resolve("./config/lib/sequelize")),logger=require(path.resolve("./config/lib/logger")).getLogger_FileNameBase(__filename),dbLogging=!1===config.db.option.timingSchemeLogging?{logging:!1}:{};module.exports={schemes:[],UNIT:dbTools.getBaseCodesObj("TimingUnit",null,"code","id"),init:function(){logger.info("timingScheme init...");var t=this;return sequelize.model("TimingScheme").findAll(Object.assign({where:{isenabled:1},include:[{as:"wps",model:sequelize.model("WorkPosition"),through:{as:"tb",attributes:[]}},{as:"hd",model:sequelize.model("Holiday")},{as:"wd",model:sequelize.model("WorkingDays")},{as:"wt",model:sequelize.model("WorkRestTime")}],order:["id"]},dbLogging)).then(function(e){var i=[];e.forEach(function(e){var r=t._genSch(e);r&&"object"==typeof r?i.push(r):logger.error("genSch %j error: %s",e.toJSON(),r)}),t.schemes=i,logger.debug("timingScheme valid count %d",t.schemes.length)}).catch(function(t){logger.error("timingScheme findall error:",t)})},_genWt:function(t){return t.map(function(t){return{starttime:putils.clearTime(t.starttime),endtime:putils.clearTime(t.endtime),worktime:putils.clearDate(t.worktime),resttime:putils.clearDate(t.resttime)}}).sort(function(t,e){return t.starttime>e.starttime?1:t.starttime<e.starttime?-1:t.worktime>e.worktime?1:t.worktime<e.worktime?-1:0})},_getWorkTime:function(t,e){var i=[];return e.forEach(function(e){e.starttime<=t&&t<=e.endtime&&i.push({begin:e.worktime,end:e.resttime})}),i},_getWorkTimeSeg:function(t){var e,i=[];return t.forEach(function(t){e&&t.starttime.getTime()===e.getTime()||(i.push(t),e=t.starttime)}),i},_genHdWd:function(t){return t.map(function(t){return{starttime:putils.clearTime(t.starttime),endtime:putils.clearTime(t.endtime)}}).sort(function(t,e){return t.starttime>e.starttime?1:t.starttime<e.starttime?-1:0})},_genWorkPosition:function(t){return t.map(function(t){return t.name})},_isWorkDay:function(t,e){if(e.hd.find(function(e){return e.starttime<=t&&t<=e.endtime}))return!1;var i=t.getDay();if(6===i||0===i){if(!e.wd.find(function(e){return e.starttime<=t&&t<=e.endtime}))return!1}return!0},_genSch:function(t){if(!t)return"schData is not valid";var e=dbTools.getModelValues(t);if(t=t.toJSON(),0===t.wt.length)return"schData workresettime not valid";var i=t.wt=this._genWt(t.wt);t.hd=this._genHdWd(t.hd),t.wd=this._genHdWd(t.wd),e.startDate=i[0].starttime,e.endDate=i[i.length-1].endtime,e.workposition=this._genWorkPosition(t.wps),e.data=[];for(var r=this._getWorkTimeSeg(i),n=0;n<r.length;n++)for(var o,a=this._getWorkTime(r[n].starttime,i),u=r[n].starttime;u<=r[n].endtime;u.setDate(u.getDate()+1))this._isWorkDay(u,t)?o?o.days++:(o={begin:new Date(u),days:1},a&&(o.timeSection=a,a=null),e.data.push(o)):o=null;return e},_matchScheme:function(t,e,i,r){var n=-1;if(!t)return logger.error("timeScheme _matchScheme argument sch not valid"),n;var o=t.data;if(o&&o.length>0){var a=o[0].begin,u=o[o.length-1],s=new Date(u.begin);s.setDate(s.getDate()+u.days),a<=e&&s>e?n+=2:s>e&&(n+=1)}if(n<0)return n;if(i)if(t.workposition&&t.workposition.length>0){if(-1===t.workposition.indexOf(i))return-1;n+=2}else n+=1;return"number"!=typeof r||isNaN(r)||(n+=10*(9-Math.abs(r-t.urgency))),n},select:function(t,e,i){var r,n=-1;return t instanceof Date&&!isNaN(t.getTime())?e&&"string"!=typeof e?null:(void 0===i||null===i?i=0:"number"!=typeof i&&(i=parseInt(i,10)),isNaN(i)?null:(this.schemes.forEach(function(o){var a=this._matchScheme(o,t,e,i);a>n&&(n=a,r=o)},this),r)):null},_msToDuration:function(t,e){return t.unit===this.UNIT.DAY?e/t.dayDuration:t.unit===this.UNIT.MINUTE?e/6e4:e/36e5},_durationToMs:function(t){return t.unit===this.UNIT.DAY?t.duration*t.dayDuration:t.unit===this.UNIT.MINUTE?60*t.duration*1e3:60*t.duration*60*1e3},_minusMs:function(t,e){var i=this._msToDuration(t,e);return t.duration-i},plusDuration:function(t,e){var i=this._durationToMs({duration:e.duration,unit:e.unit,dayDuration:t.dayDuration}),r=this._msToDuration(t,i);return t.duration+r},_plusTime:function(t,e){var i=this._durationToMs(e);return t.setMilliseconds(t.getMilliseconds()+i),t},_calcDayDuration:function(t){return t.reduce(function(t,e){return t+(e.end-e.begin)},0)},_calcDayTime:function(t,e,i){for(var r=putils.clearDate(i),n=0;n<t.length;n++){var o,a=t[n];if(r<=a.begin?(o=a.end-a.begin,r=new Date(a.begin)):o=r>=a.end?0:a.end-r,o>0){var u=this._minusMs(e,o);if(u<=0)return putils.copyDate(i,r),this._plusTime(r,e);e.duration=u}}return null},calcSchEndDt:function(t,e,i){if(!t)return logger.error("timeScheme calcSchEndDt argument sch not valid"),null;if(!i||"object"!=typeof i)return logger.error("timeScheme calcSchEndDt argument duration not valid:",i),null;if("number"!=typeof i.duration&&(i.duration=Number(i.duration)),isNaN(i.duration)||i.duration<0)return logger.error("timeScheme calcSchEndDt argument duration not valid:",i),null;i.unit=parseInt(i.unit,10),(i.unit!==this.UNIT.DAY&&i.unit!==this.UNIT.MINUTE||isNaN(i.unit))&&(i.unit=this.UNIT.HOUR);var r=t.data;if(!r||0===r.length)return logger.error("timeScheme calcSchEndDt argument sch.data not valid"),null;for(var n,o,a=!1,u=0;u<r.length;u++){var s=r[u];if(s.timeSection&&(o=s.timeSection,i.dayDuration=this._calcDayDuration(o)),!o)return logger.error("timeScheme calcSchEndDt sch no timeSection error"),null;var l=s.days;if(!a){var c=new Date(s.begin);if(c.setDate(c.getDate()+s.days),c>e&&(a=!0,s.begin<e)){if(n=this._calcDayTime(o,i,e))return n;l-=Math.floor((e-s.begin)/864e5)+1}}if(a&&l>0){var d=this._durationToMs(i),m=d/i.dayDuration;if(!(m>=l)){m=Math.floor(m),i.duration=this._minusMs(i,m*i.dayDuration);var g=new Date(s.begin);return g.setDate(g.getDate()+s.days-l+m),(n=this._calcDayTime(o,i,g))||(logger.error("timeScheme calcSchEndDt end fail, dt:%s duration :",e,i),null)}i.duration=this._minusMs(i,l*i.dayDuration)}}return logger.error("timeScheme calcSchEndDt not end fail, dt:%s duration:",e,i),null},calcEndDt:function(t,e,i,r){var n=this.select(t,i,r);if(!n)return logger.warn("calcEndDt no find sch, dt=%s, workposition=%s, urgency=%d",t.toJSON(),i,r),null;if(Array.isArray(e)){for(var o=[],a=0;a<e.length;a++){var u=e[a];if(o[a]=this.calcSchEndDt(n,t,u),!o[a])return logger.warn("calcEndDt %d error, dt=%s, workposition=%s, urgency=%d",a,t.toJSON(),i,r,u),null}return o}return this.calcSchEndDt(n,t,e)}};