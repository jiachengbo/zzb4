"use strict";var path=require("path"),fs=require("fs"),util=require("util"),child_process=require("child_process"),config=require(path.resolve("./config/config")),logger=require(path.resolve("./config/lib/logger")),saveDir="docfile",diskDir=path.resolve(config.uploads.rootDiskDir,saveDir),mountDir=path.join(config.uploads.rootMountDir,saveDir).replace(/\\/g,"/"),distType="html",typeParam={html:":XHTML Writer File:UTF8"};exports.read=function(e,i){if(!e.docfile)return logger.warn("conv docfile arg null"),i.status(404).send({message:"没有参数docfile"});var r=path.join(diskDir,e.docfile);fs.exists(r,function(s){if(!s)return logger.warn("conv docfile %s not exists",r),i.status(404).send("参数文件不存在:"+r);var o=distType+(typeParam[distType]?typeParam[distType]:""),t=util.format('"%s" --headless --convert-to "%s"  --outdir "%s" "%s"',config.sofficePathName,o,diskDir,r);child_process.execSync(t);var a=path.basename(e.docfile,path.extname(e.docfile))+"."+distType,n=path.join(diskDir,a);if(!fs.existsSync(n))return i.status(404).send("转换后的文件不存在:"+n);var c={};i.sendFile(n,c,function(e){e?logger.warn("conv docfile send %s fail:",n,e.message):logger.debug("conv docfile Sent:",n)})})},exports.docfile=function(e,i,r,s){e.docfile=s,r()};