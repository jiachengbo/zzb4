"use strict";function getStateInfo(e){return statesInfo[e]}function getActInfo(e){return actsInfo[e]}function getStateCanActs(e,r){var t=e?e.state_id:RECSTATES.INIT,i=[];switch(t){case RECSTATES.INIT:var a;a=dbTools.getParamData("have_verify_state")?r.roles.includes("xxxx")?RECSTATES.WAITACCEPT:RECSTATES.WAITVERIFY:RECSTATES.WAITACCEPT,i[RECACT.RECORD]=a,i[RECACT.AUTOFH]=RECSTATES.CLOSED;break;case RECSTATES.WAITVERIFY:i[RECACT.VERIFYDISPATCH]=RECSTATES.WAITVERIFIED,i[RECACT.UPDATE]=t;break;case RECSTATES.WAITVERIFIED:i[RECACT.VERIFYRET]=RECSTATES.WAITACCEPT,i[RECACT.BACK]=RECSTATES.WAITVERIFY;break;case RECSTATES.WAITACCEPT:i[RECACT.ACCEPT]=RECSTATES.ACCEPTED,i[RECACT.VERIFYDISPATCH]=RECSTATES.WAITVERIFIED,i[RECACT.DISCARD]=RECSTATES.DISCARDED,i[RECACT.UPDATE]=t;break;case RECSTATES.ACCEPTED:i[RECACT.REGISTER]=RECSTATES.WAITHANDLE,i[RECACT.CLOSE]=RECSTATES.CLOSED,i[RECACT.DISCARD]=RECSTATES.DISCARDED,i[RECACT.UPDATE]=t;break;case RECSTATES.WAITHANDLE:i[RECACT.HANDLEDISPATCH]=RECSTATES.WAITHANDLED,i[RECACT.TRANSFER]=RECSTATES.WAITSUPERVISE,i[RECACT.POSTPONE]=t,i[RECACT.SUSPEND]={},i[RECACT.SUSPEND][AUTHORIZE.PASS]=RECSTATES.SUSPENDED,i[RECACT.UPDATE]=t;break;case RECSTATES.WAITHANDLED:i[RECACT.HANDLERET]=RECSTATES.HANDLED,i[RECACT.BACK]=RECSTATES.WAITHANDLE,i[RECACT.SUPERINTEND]=t,i[RECACT.POSTPONE]=t;break;case RECSTATES.HANDLED:i[RECACT.TRANSFER]=RECSTATES.WAITCHECK,i[RECACT.HANDLEDISPATCH]=RECSTATES.WAITHANDLED,i[RECACT.SUSPEND]={},i[RECACT.SUSPEND][AUTHORIZE.PASS]=RECSTATES.SUSPENDED;break;case RECSTATES.WAITCHECK:i[RECACT.CHECKDISPATCH]=RECSTATES.WAITCHECKED,i[RECACT.TRANSFER]=RECSTATES.WAITSUPERVISE;break;case RECSTATES.WAITCHECKED:i[RECACT.CHECKRET]=RECSTATES.CHECKED,i[RECACT.BACK]=RECSTATES.WAITCHECK;break;case RECSTATES.CHECKED:i[RECACT.TRANSFER]=RECSTATES.WAITSUPERVISE,i[RECACT.CHECKDISPATCH]=RECSTATES.WAITCHECKED;break;case RECSTATES.WAITSUPERVISE:i[RECACT.CLOSE]=RECSTATES.CLOSED,i[RECACT.DISCARD]=RECSTATES.DISCARDED,i[RECACT.TRANSFER]=RECSTATES.WAITHANDLE,i[RECACT.UPDATE]=t;break;case RECSTATES.SUSPENDED:case RECSTATES.CLOSE:case RECSTATES.DISCARDED:break;default:return logger.error("getStateCanActs no state %d defined",t),null}return t!==RECSTATES.INIT&&(i[RECACT.LOCK]=t),-1===[RECSTATES.INIT,RECSTATES.CLOSE,RECSTATES.DISCARDED,RECSTATES.SUSPENDED].indexOf(t)&&(i[RECACT.PRIREC]=t),-1===[RECSTATES.INIT,RECSTATES.WAITACCEPT].indexOf(t)&&(i[RECACT.UNDO]=e.prevstate_id),i}function getNextState(e,r,t){var i=e?e.state_id:RECSTATES.INIT,a=getStateCanActs(e,t);if(!a)return logger.error("getNextState=>getStateCanActs state %d return null",i),null;var c=a[r.act_id];if("number"==typeof c)return c;if(!c)return logger.error("getNextState state %d, act_id %d return null",i,r.act_id),null;var d;return r.hasOwnProperty("act_childid")&&c.hasOwnProperty(r.act_childid)&&(d=c[r.act_childid]),"number"!=typeof d?(logger.error("getNextState state %d, act_id %d, act_childid %s return not number:",i,r.act_id,r.act_childid,c),null):d}function getStateChangedActs(e){var r=[];return e&&Array.isArray(e)?(e.forEach(function(e){e.old_state_id!==e.new_state_id&&(e.act_id===RECACT.UNDO?r.pop():r.push(e))}),r):(logger.warn("getStateChangedActs no valid acts"),r)}function genCaseNum(e,r,t){var i=e?e.get():{};Object.assign(i,r);var a=dbTools.getBaseCode("ProblemSources",{id:i.eventsrcid},"shortening");a||(a="");var c;if(i.casenum){var d=i.casenum.charAt(0);if(d>="A"&&d<="Z"){if(d===a)return;c=i.casenum.slice(1)}else c=i.casenum}else c=digitalCtrl.genCaseNum(t);r.casenum=a+c}function setRecTimeLimit(e,r){var t=e?e.get():{};Object.assign(t,r);var i=digitalCtrl.getTimeLimit(t);if(!i)throw new Error("服务器校验错误，设置案件时限（null）.");Object.assign(r,i)}function addRecTimeLimit(e,r,t,i){var a=e?e.get():{};Object.assign(a,r);var c=digitalCtrl.addTimeLimit(a,t,i);if(!c)throw new Error("服务器错误，增加案件时限（null）.");Object.assign(r,c)}function setRecAllTimeLimit(e,r){var t=e?e.get():{};Object.assign(t,r);var i=digitalCtrl.getAllTimeLimit(t);if(!i)throw new Error("服务器错误，设置记录总超时时限（null）.");Object.assign(r,i)}function addRecAllTimeLimit(e,r,t,i){var a=e?e.get():{};Object.assign(a,r);var c=digitalCtrl.addAllTimeLimit(a,t,i);if(!c)throw new Error("服务器错误，增加记录总超时时限（null）.");Object.assign(r,c)}function setFileFields(e,r,t,i){function a(e){return logger.debug("recv file %s",e.filename),path.join(uploadImage.mountDir,e.filename).replace(/\\/g,"/")}if(r.fileFields&&r.fileFields.length>0){var c=[];if(t&&Array.isArray(t[actFileField])&&t[actFileField].length>0){var d=t[actFileField].map(a);e[r.fileFields[0]]=d,c=c.concat(d)}r.fileFields.forEach(function(r){var d;r in i&&!e[r]&&(d=i[r]?Array.isArray(i[r])?i[r]:[i[r]]:[]),t&&Array.isArray(t[r])&&t[r].length>0&&(d||(d=[]),d=d.concat(t[r].map(a))),d&&(e[r]=d,c=c.concat(d))}),e.act.act_photo=c}}var path=require("path"),multer=require(path.resolve("./config/private/multer")),sequelize=require(path.resolve("./config/lib/sequelize")),dbTools=require(path.resolve("./config/private/dbtools")),putils=require(path.resolve("./config/private/utils")),digitalCtrl=require(path.resolve("./modules/digital/server/controllers/digital.server.controller")),logger=require(path.resolve("./config/lib/logger")).getLogger_FileNameBase(__filename);const RECSTATES=dbTools.getBaseCodesObj("J_rec_state",null,"code","id"),RECACT=dbTools.getBaseCodesObj("J_rec_actcode",null,"code","id"),AUTHORIZE=dbTools.getBaseCodesObj("J_rec_authorize",null,"code","id");var whiteTorecFields=[{name:"address",required:!0},{name:"districtid",required:!0},{name:"streetid",required:!0},{name:"communityid",required:!0},{name:"cellid",required:!0},{name:"eventdesc",required:!0},{name:"eventsrcid",required:!0,intype:Number},{name:"rectypeid",required:!0,intype:Number},{name:"eventtypeid",required:!1,intype:Number},{name:"maintypeid",required:!1,intype:Number},{name:"subtypeid",required:!1,intype:Number},{name:"timeareaid",required:!1,intype:Number},{name:"coordinatex",required:!0,intype:Number},{name:"coordinatey",required:!0,intype:Number}],whiteTocallrecordFields=[{name:"id",required:!1},{name:"calltypeid",required:!1,intype:Number},{name:"telcall",required:!1},{name:"calltime",required:!1},{name:"returnvisitflag",required:!1,default:""},{name:"returnvisitphone",required:!1,default:""},{name:"name",required:!1,default:""},{name:"address",required:!1,default:""},{name:"sex",required:!1,default:""}],whiteActFields=[{name:"act_id",required:!0,intype:Number},{name:"act_childid",required:!1,intype:Number,default:0},{name:"act_content",required:!1,default:""},{name:"act_recvuserid",required:!1,intype:Array,default:null},{name:"act_other",required:!1,default:null},{name:"act_photo",required:!1,default:null}],uploadImage=new multer("torec",10485760,/image/,".jpg"),actFileField="act[act_photo]",allRecvFiles=[{name:"create_photo"},{name:"check_photo"},{name:"verify_photo"},{name:"handle_photo"},{name:actFileField}],statesInfo=function(){function e(e,t){if(!e||void 0===RECSTATES[e])throw new Error("addStateInfo stateid:"+e+" not exists:"+JSON.stringify(t));if(r[RECSTATES[e]])throw new Error("addStateInfo stateid "+e+" already exists");r[RECSTATES[e]]=t||{}}var r=[];return e("INIT"),e("WAITACCEPT"),e("ACCEPTED"),e("WAITVERIFY"),e("WAITVERIFIED"),e("WAITHANDLE"),e("WAITHANDLED"),e("HANDLED"),e("WAITCHECK"),e("WAITCHECKED"),e("CHECKED"),e("WAITSUPERVISE"),e("CLOSED"),e("DISCARDED"),e("SUSPENDED"),r}(),actsInfo=function(){function e(e,t){if(!e||void 0===RECACT[e])throw new Error("addActInfo actid:"+e+" not exists:"+JSON.stringify(t));if(r[RECACT[e]])throw new Error("addActInfo actid "+e+" already exists");r[RECACT[e]]=t||{}}var r=[];return e("NONE"),e("RECORD",{fileFields:["create_photo"],recTimeField:"create_time",recUserIdField:"create_userid",updateAllErrorTime:!0}),e("UPDATE",{fileFields:["create_photo"],updateAllErrorTime:!0}),e("AUTOFH",{fileFields:["create_photo","handle_photo"],recTimeField:"create_time",recUserIdField:"create_userid",updateAllErrorTime:!0}),e("VERIFYRET",{fileFields:["verify_photo"],recErrorTimeField:"verify_errortime",recTimeField:"verify_time",recUserIdField:"verify_userid"}),e("CHECKRET",{fileFields:["check_photo"],recErrorTimeField:"check_errortime",recTimeField:"check_time",recUserIdField:"check_userid"}),e("HANDLERET",{fileFields:["handle_photo"],recErrorTimeField:"handle_errortime",recTimeField:"handle_time",recUserIdField:"handle_userid"}),e("ACCEPT",{recErrorTimeField:"accept_errortime",recTimeField:"accept_time",recUserIdField:"accept_userid",updateAllErrorTime:!0}),e("REGISTER",{recErrorTimeField:"register_errortime",recTimeField:"register_time",recUserIdField:"register_userid"}),e("VERIFYDISPATCH",{recErrorTimeField:"verifydispatch_errortime",recTimeField:"verifydispatch_time",recUserIdField:"verifydispatch_userid",recRecvUserIdField:"verifydispatch_recvuserid"}),e("HANDLEDISPATCH",{recErrorTimeField:"handledispatch_errortime",recTimeField:"handledispatch_time",recUserIdField:"handledispatch_userid",recRecvUserIdField:"handledispatch_recvuserid"}),e("CHECKDISPATCH",{recErrorTimeField:"checkdispatch_errortime",recTimeField:"checkdispatch_time",recUserIdField:"checkdispatch_userid",recRecvUserIdField:"checkdispatch_recvuserid"}),e("CLOSE",{recErrorTimeField:"close_errortime",recTimeField:"close_time",recUserIdField:"close_userid",recContentField:"close_content"}),e("DISCARD",{recErrorTimeField:"discard_errortime",recTimeField:"discard_time",recUserIdField:"discard_userid",recContentField:"discard_content"}),e("SUSPEND",{recErrorTimeField:"suspend_errortime",recTimeField:"suspend_time",recUserIdField:"suspend_userid",recContentField:"suspend_content"}),e("TRANSFER"),e("UNDO"),e("BACK"),e("PRIREC"),e("SUPERINTEND"),e("POSTPONE"),e("LOCK"),r}();exports.ctrlAct=function(e,r,t){function i(e,r,t,i){e.recTimeField&&(r[e.recTimeField]=i?null:a),e.recUserIdField&&(r[e.recUserIdField]=i?null:c.id),e.recContentField&&(r[e.recContentField]=i?null:r.act.act_content),e.recRecvUserIdField&&(r[e.recRecvUserIdField]=i?null:r.act.act_recvuserid),e.recErrorTimeField&&(i?r[e.recErrorTimeField]=null:r.errortime?r[e.recErrorTimeField]=r.errortime:t&&(r[e.recErrorTimeField]=t.errortime))}var a=new Date,c=e.user,d={},o=t?t.state_id:RECSTATES.INIT;return new Promise(function(t,i){r?uploadImage.recv(e,r,allRecvFiles).then(t).catch(i):t(null)}).then(function(r){if(!e.body)throw logger.error("torec ctrlAct body not valid"),new Error("服务器校验错误，请求参数没有内容");if(o===RECSTATES.INIT)e.body.act&&(d.act=putils.checkFields(whiteActFields,e.body.act)),d.act=Object.assign({act_id:RECACT.RECORD,act_childid:0,act_content:"添加新记录"},d.act);else{if("state_id"in e.body&&Number(e.body.state_id)!==o)throw logger.error("torec ctrlAct body.state_id %s not equ current state_id %d, userid:%d, casenum: %s",e.body.state_id,o,c.id,t.casenum),new Error("服务器校验错误，案件状态已经改变："+e.body.state_id+"!="+o);if(!e.body.act)throw logger.error("torec ctrlAct body.act not valid"),new Error("服务器校验错误，请求参数没有动作内容："+JSON.stringify(e.body));d.act=putils.checkFields(whiteActFields,e.body.act)}if(!d.act||"object"!=typeof d.act)throw logger.error("torec get act no column error:",d.act),new Error("服务器校验错误，没有规定的动作记录字段"+d.act);var l=d.act.act_id;if(isNaN(l)||l<=0)throw logger.error("torec get act column id error:",d.act.act_id),new Error("服务器校验错误，动作id"+d.act.act_id);var E=d.act.act_childid;if(isNaN(E)||E<0)throw logger.error("torec get act column childid error:",d.act.act_childid),new Error("服务器校验错误，子动作id"+d.act.act_childid);var s=getActInfo(d.act.act_id);if(!s)throw new Error("create/update no act "+d.act.act_id+" defined");if(d.state_id=getNextState(t,d.act,c),!d.state_id)throw new Error("torec oldstate "+o+" act "+d.act.act_id+" getNextState return error");switch(o!==d.state_id&&(d.prevstate_id=o,d.statechanged_time=a,d.lock_time=null,d.lock_userid=null),d.act=Object.assign({act_userid:c.id,act_time:a,old_state_id:o,new_state_id:d.state_id},d.act),setFileFields(d,s,r,e.body),d.act.act_id){case RECACT.AUTOFH:d.handle_time=a,d.handle_userid=c.id;case RECACT.RECORD:(c.roles.includes("accept_role")||c.roles.includes("admin"))&&(d.lock_time=a,d.lock_userid=c.id);case RECACT.UPDATE:var n=putils.checkFields(whiteTorecFields,e.body);if(!n||"string"==typeof n)throw logger.error("torec register no column error:",n),new Error("服务器校验错误，没有规定案件记录字段"+n);if(Object.assign(d,n),e.body.crd){var T=putils.checkFields(whiteTocallrecordFields,e.body.crd);if(!T||"string"==typeof T)throw logger.error("tocallrecord register no column error:",T),new Error("服务器校验错误，没有规定呼叫记录字段"+T);d.crd=T}genCaseNum(t,d,a);break;case RECACT.SUPERINTEND:d.urgentflag=d.act.act_childid,d.urgentflag===AUTHORIZE.APPLY&&d.act.act_other&&(d.act.act_content+="("+d.act.act_other+"天)");break;case RECACT.ACCEPT:case RECACT.PRIREC:d.priflag=parseInt(d.act.act_other,10),isNaN(d.priflag)&&(d.priflag=0);break;case RECACT.POSTPONE:if(d.postponeflag=d.act.act_childid,d.postponeflag===AUTHORIZE.APPLY||d.postponeflag===AUTHORIZE.PASS||d.postponeflag===AUTHORIZE.NOPASS){var C=d.act.act_other.split(",");if(2!==C.length)throw logger.error("postpone pass act_other error:",d.act.act_other),new Error("服务器校验错误，延期参数:"+d.act.act_other);var A=parseFloat(C[0]);if(isNaN(A)||A<=0)throw logger.error("postpone pass act_other duration error:",d.act.act_other),new Error("服务器校验错误，延期时间:"+d.act.act_other);var u=parseFloat(C[1]);if(isNaN(u)||u<=0)throw logger.error("postpone pass act_other unit error:",d.act.act_other),new Error("服务器校验错误，延期时间单位:"+d.act.act_other);d.act.act_content+="("+A+dbTools.getBaseCode("TimingUnit",{id:u},"name")+")",d.postponeflag===AUTHORIZE.PASS&&(addRecTimeLimit(t,d,A,u),addRecAllTimeLimit(t,d,A,u))}break;case RECACT.SUSPEND:d.suspendflag=d.act.act_childid;break;case RECACT.LOCK:if(d.act.act_childid===AUTHORIZE.NONE){d.lock_time=null,d.lock_userid=null;var S={};c.roles.includes("monitor_role")||c.roles.includes("admin")||(S.lock_userid={$or:[c.id,null]}),d.where=S}else d.lock_time=a,d.lock_userid=c.id,d.where={lock_userid:{$or:[c.id,null]}};break;case RECACT.UNDO:delete d.lock_time,delete d.lock_userid;var R=t.get("act"),_=getStateChangedActs(R);if(_.length<2)throw logger.error("undo getStateChangedActs ret length < 2 error:",R),new Error("服务器校验错误，不能回退（-1）");var m=_.pop();if(m.old_state_id!==d.state_id)throw logger.error("undo lastact prev state %d error:",m.old_state_id,R),new Error("服务器校验错误，不能回退（-2）");var g=getActInfo(m.act_id);if(!g)throw logger.error("undo lastAct act_id %d error:",m.act_id,R),new Error("服务器校验错误，不能回退（-3）");var h=_.pop();if(h.new_state_id!==d.state_id)throw logger.error("undo lastPrevAct new state %d error:",h.new_state_id,R),new Error("服务器校验错误，不能回退（-4）");i(g,d,t,!0),d.prevstate_id=h.old_state_id}switch(Object.assign(d,{lastact_actid:d.act.act_id,lastact_userid:d.act.act_userid,lastact_time:d.act.act_time,lastact_content:d.act.act_content,lastact_recvuserid:d.act.act_recvuserid,lastact_actchildid:d.act.act_childid}),i(s,d,t),o!==d.state_id&&setRecTimeLimit(t,d),s.updateAllErrorTime&&setRecAllTimeLimit(t,d),d.act.act_id){case RECACT.AUTOFH:d.state_id===RECSTATES.CLOSED&&(d.accept_time=d.register_time=d.close_time=d.create_time,d.accept_errortime=d.register_errortime=d.handle_errortime=d.close_errortime=d.create_time)}return digitalCtrl.calc(t,d)}).then(function(e){return e&&(d.calc=e),d})},exports.getStateCanActs=getStateCanActs;